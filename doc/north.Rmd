---
geometry: margin=1in
month: "`r format(Sys.Date(), '%B')`"
year: "`r format(Sys.Date(), '%Y')`"
params:
    model: "south"
preamble: |
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{placeins}
  - \usepackage{enumerate}
  - \usepackage[inline]{showlabels}
  - \usepackage{lineno} 
output:
  sa4ss::techreport_pdf:
    default
  bookdown::pdf_document2:
    keep_tex: true
    keep_md: true
lang: en
papersize: a4
---

<!-- Common lat/long 
Cape Mendocino, Pt. Conception and OR border -->
\newcommand\CapeM{$40^\circ 10^\prime N$}
\newcommand\PtC{$34^\circ 27^\prime N$}
\newcommand\CAOR{$42^\circ 00^\prime N$}


```{r opts, include = FALSE}
library(kableExtra)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::knit_hooks$set(plot = function(x,options) {
      base = knitr::opts_knit$get('base.url')
      if (is.null(base)) base = ''
      alt = ifelse (is.null(options$alt),"",options$alt)
      cap = ifelse (is.null(options$caption),"",options$caption)
      if (alt != ""){
        sprintf('![%s](%s%s "%s")', cap, base, x, alt)
      } else {
        sprintf('![%s](%s%s)', cap, base, x)
        }
  })
options(knitr.duplicate.label = "allow") #allow duplicate labels - needed for longtable
options(knitr.kable.NA = '') #print blank cells in tables with NA
#knitr::knit_hooks$set(crop = knitr::hook_pdfcrop) #crop figures
#knitr::knit_hooks$set(optipng = knitr::hook_optipng) #optimize figure size


source("C:/Stock_Assessments/VRML_Assessment_2021/GitHub/Vermilion_2021/code/dir_recent.R")
dir.path <- ifelse(params$model=="north",
             "C:/Stock_Assessments/VRML_Assessment_2021/Model_files/NCA/",
             "C:/Stock_Assessments/VRML_Assessment_2021/Model_files/SCA/")
model.dir <- dir_recent(dir = dir.path, pattern = "Verm")
base_loc <- paste0(model.dir,"/")


if (is.null(params$model) & file.exists("00mod.Rdata")) {
  stopifnot(file.exists("00mod.Rdata"))
  load("00mod.Rdata")
} else {
  load(dir(base_loc, pattern = "00mod.Rdata", full.names = TRUE))
}

model.area <- ifelse(params$model=="north", "NCA", "SCA")
spp = 'vermilion rockfish'
Spp = 'Vermilion rockfish'
fig_loc = paste0(getwd(), "/figures")
base_loc_plots = paste0(base_loc,"plots")
table_loc = paste0(getwd(), "/tables/")
tex_tables_loc = paste0(getwd(),"/tex_tables/", params$model)
tex_parent_loc = paste0(getwd(),"/tex_tables/")
#move the tex tables to the parent folder depending on which model you're working on 
#best solution I have so far
files <- list.files(path = tex_tables_loc, full.names = TRUE)
files_new <- gsub(dirname(files[1]), tex_parent_loc, files)
for (i in 1:length(files)){
  file.copy(files[i], files_new[i])
}


# model_loc = "C:/Stock_Assessments/VRML_Assessment_2021/Model_files/"



if(params$model=="north"){
model$FleetNames_parsed <- c("commercial hook-and-line fishery",
                           "commercial trawl fishery",
                           "commercial net fishery",
                           "recreational PC retained fishery",
                           "recreational PC discard fishery",
                           "recreational PR retained fishery",
                           "recreational PR discard fishery",
                           "Deb Wilson-Vandenberg onboard survey",
                           "West coast groundfish bottomfish trawl survey",
                           "recreational PC onboard survey",
                           "Abrams thesis research survey",
                           "SWFSC groundfish ecology survey",
                           "California Collaborative Fisheries Research Project survey")
} else {
model$FleetNames_parsed <- c("commercial hook-and-line fishery",
                           "commercial trawl fishery",
                           "commercial net fishery",
                           "recreational PC retained fishery",
                           "recreational PC discard fishery",
                           "recreational PR retained fishery",
                           "recreational PR discard fishery",
                           "NWFSC hook-and-line survey",
                           "West Coast Groundfish Bottomfish Trawl Survey",
                           "recreational PC onboard survey",
                           "CDFW reserach (aka green binder)",
                           "Dummy fleet")
}

model$FleetNames_label <- stringr::str_replace_all(model$FleetNames, "_", "-")

fleet_info = data.frame(cbind(model$fleet_ID, model$FleetNames, model$FleetNames_label, model$FleetNames_parsed))
colnames(fleet_info) = c("fleet_ID", "FleetNames", "FleetNames_label", "FleetNames_parsed")

plot_info = read.csv(file.path(mod_loc, "plots", "plotinfotable_for_doc.csv"))

```

<!--chapter:end:00a.Rmd-->

---
author:
  - name: Melissa H. Monk
    code: 1
    first: M
    middle: H
    family: Monk
  - name: E. J. Dick
    code: 1
    first: E
    middle: J
    family: Dick
  - name: John C. Field
    code: 1
    first: J
    middle: C
    family: Field
  - name: Emma M. Saas
    code: 1
    first: E
    middle: M
    family: Saas
author_list: Monk, M.H., E.J. Dick, J.C. Field, E.M. Saas
affiliation:
  - code: 1
    address: Southwest Fisheries Science Center, U.S. Department of Commerce, National
      Oceanic and Atmospheric Administration, National Marine Fisheries Service, 110
      McAllister Way, Santa Cruz, California 95060
address: ^1^Southwest Fisheries Science Center, U.S. Department of Commerce, National
  Oceanic and Atmospheric Administration, National Marine Fisheries Service, 110 McAllister
  Way, Santa Cruz, California 95060
---

<!--chapter:end:00authorsnorth.Rmd-->

---
bibliography:
  - sa4ss.bib
---

<!--chapter:end:00bibliography.Rmd-->

---
title: The status of Vermilion Rockfish (_Sebastes miniatus_) and Sunset Rockfish (_Sebastes crocotulus_) in U.S. waters off the coast of California north of Pt. Conception in 2021
---

<!--chapter:end:00titlenorth.Rmd-->

\includegraphics{cover_photo.png}
Two fish of the vermilion/sunset cryptic species pair.  Confirmation of 
species can only be determined via genetic analysis and species identification 
of these two fish caught in the Santa Barbara channel at approximately 250 ft depth 
is unknown. Photo courtesy of Sabrina Beyer.


\printnoidxglossary[sort=word]

\newpage

<!--chapter:end:01a-photo.Rmd-->

\pagebreak
\pagenumbering{roman}
\setcounter{page}{1}

\renewcommand{\thetable}{\roman{table}}
\renewcommand{\thefigure}{\roman{figure}}


\setlength\parskip{0.5em plus 0.1em minus 0.2em}

\newpage

<!--chapter:end:01a.Rmd-->

```{r executive, echo = FALSE}
executive <- list()
executive[["stock"]] <- paste0("This assessment reports the status of the 
Vermilion Rockfish (_Sebastes miniatus_) and Sunset Rockfish 
(_Sebastes crocotulus_) in U.S. waters off the coast of California south
  of Pt. Conception through 2020.")
```
# Executive Summary{-}
To be completed after the STAR panel.

## Stock{-}
This assessment reports the status of the vermlion rockfish (_Sebastes miniatus_) 
and sunset rockfish (_Sebastes crocotulus_) complex (referred to as vermilion 
throughout), resource in U.S. waters off the coast of California `r params$model` 
of Point Conception ($34^\circ 27^\prime$ N. latitude) using data 
through 2020.


## Landings{-}
Replace text.

## Data and Assessment{-}
Replace text.

## Stock Biomass{-}
Replace text.

## Recruitment{-}
Replace text.

## Exploitation Status{-}
Replace text.

## Reference Points{-}
Replace text.

## Management Performance{-}
Replace text.

## Unresolved Problems and Major Uncertainties{-}
Replace text.

## Decision Table{-}
Replace text.

## Research and Data Needs{-}
Replace text.

<!--chapter:end:01executive.Rmd-->

\pagebreak
\setlength{\parskip}{5mm plus1mm minus1mm}
\pagenumbering{arabic}
\setcounter{page}{1}
\renewcommand{\thefigure}{\arabic{figure}}
\renewcommand{\thetable}{\arabic{table}}
\setcounter{table}{0}
\setcounter{figure}{0}

<!--chapter:end:10a.Rmd-->

# Introduction
Note to readers: Text in section is the same in both California `r spp` assessment 
documents.

```{r render-12, results = "asis"}
sa4ss::read_child("12basicinfo.Rmd")
```


```{r render-13, results = "asis"}
sa4ss::read_child("13fisheries.Rmd")
```


<!--chapter:end:11introduction.Rmd-->

# Data

The STAT presented proposed analyses and data sources for the 2021 `r spp` 
assessment during the PFMC Pre-Assessment Workshop for 2021 Vermilion and 
Lingcod Stock Assessments, hosted virtually on March 29, 2021. Topics addressed 
included progress on research priorities, data sources and types, stock structure, 
fleet structure, key model parameters (e.g. natural mortality), and potential 
challenges. Descriptions of each data source included in the model 
(Figure \@ref(fig:data-plot)) and sources that were explored, but not included
are included within this section.

## Fishery-Dependent Data

A complete summary of estimated `r spp` removals by each fleet in the 
commercial and recreational fleets modeled in this assessment is provided in Table 
\@ref(tab:landings).  The data sources for landings varied by each fleet and a summary 
of each data source and the time period for which it was used is in Table \@ref(tab:catch-source).
Of note is that the commercial landings are in metric tons (mt) and the recreational landings 
are in numbers of fish (thousands of fish). Data and 
methods used to derive these estimates are described in this section.

## Commercial

```{r render-21, results = "asis"}
sa4ss::read_child("21data-a-commercial.Rmd")
```

```{r render-21b, results = "asis"}
sa4ss::read_child("21data-b-recreational.Rmd")
```


## Fishery-Independent data


```{r render-21c, results = "asis"}
sa4ss::read_child("21data-c-fishery-independent.Rmd")
```


## Data sources considered, but not used


```{r render-21d, results = "asis"}
sa4ss::read_child("21data-sources-not-used.Rmd")
```

## Biology

```{r render-2, results = "asis"}
sa4ss::read_child("22biology.Rmd")
```


<!--chapter:end:20data.Rmd-->

# Assessment Model

## History of Modeling Approaches

Vermilion was assessed coastwide as a data poor species using 
Depletion-Based Stock Reduction Analysis (DB-SRA) [@Dick2010]. Average catch 
2008-2009 was 136.3 mt, and the median OFL in 2010 was 314.3 mt with a 28% 
probability that recent catch exceeded the 2010 [@Dick2010].

A 2005 assessment was not accepted for management. 
From the September 2005 [Briefing Book](https://www.pcouncil.org/documents/2005/09/f-groundfish-management-september-2005.pdf/): 
"The SSC considers the assessment to be best available science, but at this  stage does not 
endorse the results as being suitable for setting OYs." A 2013 data moderate 
assessment was prepared, but not reviewed. From Pacific Coast Groundfish Stock 
Assessment Review (STAR) Panel Report For Data-Moderate Assessments (2013): 
"There was insufficient time during the review to evaluate all the assessments 
originally requested by the Council. Assessments for vermilion/sunset rockfishes 
(*Sebastes miniatus* and *Sebastes crocotulus*) and yellowtail rockfish 
(south of \CapeM) were not presented by the Stock Assessment Team (STAT)."


### Most Recent STAR Panel and SSC Recommendations 

The 2005 STAR panel report compiled recommendations specific to vermilion, and also 
generic rockfish recommendations The generic rockfish recommendation are not 
presented here.

**Vermilion rockfish recommendations**

Investigation into the species composition of nominal vermilion rockfish is needed.
It is not clear that separate assessments for the northern and southern areas are warranted
for vermilion rockfish. Although there were differences in the estimated magnitude and
timing of recruitment events, the estimated stock trends were similar in both areas.
Pooling of data from northern and southern areas may permit a more robust assessment
model to be obtained.

*2021 STAT response.* Since the 2005 assessment, vermilion rockfish were speciated 
to vermilion and sunset rockfishes [@Hyde2009].  Sunset rockfish are more common south of 
Pt. Conception (\PtC) and historical catches and length distributions between 
the two areas are different. The STAT discussed this at the Pre-Assessment workshop 
and all participants agreed that modeling the areas separately was an appropriate 
decision.


**General rockfish Recommendations**

- The historical catch is an important input into any stock assessment. 
Although efforts have been made to construct catch time series for California rockfish, 
a more sustained effort is needed to do this for all rockfish species. It should not be 
left to individual analysts to do this for a species as stock assessments arise. It 
should be done by a specialist team for all species simultaneously, so that consistent 
times series can beestablished.

- Management changes affect fisher behaviour and alter the correct interpretation of CPUE
time series. As for catch histories, it is important that a specialist team consider and
document all management changes and how they may have impacted on catch rates for
all species. Again, this should not be left to individual assessment authors as the issues
are generic and patterns might not be obvious without a multi-species perspective.

- Improved documentation of input data and output for GLM analyses of CPFV and
RecFIN CPUE data is recommended. In general, GLM analyses should provide analysis
of deviance tables, estimated coefficients, and their standard errors to document these
calculations. Information on amount of RecFIN records filtered by species association
also needs to be presented to show the effect of the species association analysis. 
Although this method is an objective approach to filtering records, it is unknown 
how well works in practice to reduce the potential biases of CPUE data. A paper describing a
comprehensive application of GLM methods to CPFV and RecFIN CPUE data on
California rockfish would be a important contribution to the assessment process and the
primary literature.

- Many rockfish assessments use CPUE data from the CPFV fishery as an index of
population abundance. The CPFV fishery is focused primarily on marketing a successful
“fishing experience” that is related to the desirability of the species caught, quantity,
body size, and fighting characteristics. The default assumption of proportionality
between CPUE and abundance has not been evaluated for a fishery with these
characteristics. Simulation modeling of fleet dynamics in a multi-species context is one
possible way to address these issues.

- A more complete understanding of the multi-species aspects of rockfish population
dynamics is needed. Although some rockfish stocks have declined in recent decades
under heavy fishing pressure and environmental change, other rockfish species have
apparently increased. Are these species adapted to different environmental conditions, or
are these increases due to the indirect effects of reduced competition and/or predation?


Conducting additional assessments of the many relatively uncommon rockfish in
California is a difficult but worthwhile objective. To facilitate this process, 
the Panel has a number suggestions:

1. Keep the models simple.  
2. Make reasonable assumptions based on life history and better studied species for
parameters that cannot be reliably estimated, such as natural mortality, stock-recruit
steepness, selectivity.  
3. Think meta-analytically. For example, similar species that are often caught together
are likely to have experienced similar fishing mortality rates and trends. There are also
more rigorous methods for sharing information between related stocks that could be
considered.  
4. Make the most of CPUE data:  
    + For several assessments, indices from GLM analyses of site-specific CPFV data
apparently tracked population trends better than indices from RecFIN data, even
when a subset of records had been selected using the Stevens and MacCall (2004)
procedure. Greater priority should be given to collecting site-specific CPUE data.
Given the ubiquity of GPS systems and hand-held data recorders, obstacles to
collecting site-specific information from fisheries are now logistic rather than
technological.  
    + Location information for the historical groundfish catch data of all species is
currently available, in hard copy form only, from the California Department of
Fish and Game. Putting this information into electronic format would greatly
improve the ability to assign catches of all species to specific stocks on a trip-bytrip basis.  
5. Do not put too much trust in model results. Models are no better that their input data
and assumptions, and for many rockfish species, the data are sparse and potentially
misleading.  



```{r render-31, results = "asis"}
sa4ss::read_child("31model-star-responses.Rmd")
```


```{r render-32, results = "asis"}
#if(model.area=='NCA'){
sa4ss::read_child("32model-description-north.Rmd") 
#} else {
#sa4ss::read_child("32model-description-south.Rmd")
#}
```



```{r render-34, results = "asis"}
sa4ss::read_child("34model-prestar-base-selection.Rmd")
```


```{r render-35, results = "asis"}
sa4ss::read_child("35model-prestar-base-results.Rmd")
```


```{r render-36, results = "asis"}
sa4ss::read_child("36model-uncertainty.Rmd")
```



<!--chapter:end:30model.Rmd-->



# Harvest Projections and Decision Tables

**This section will be completed after the STAR panel**
<!--
Projections of OFL (mt), ABC (mt), age 10+ biomass (mt), spawning output (billions of eggs), and depletion (% of unfished spawning output) are shown for the default harvest control rule in Table 62. Catch estimates for 2021 and 2022 are based on GMT recommendations (M. Mandrup, CDFW; pers. comm.), with frog mt for commercial and frog mt for recreational fleets. Projections assume a constant allocation among fleets equal to the recommended catch for 2021 and 2022 (frog% commercial, frog% commercial).
-->

# Regional Management Considerations
The state of California implements regional management for the recreational fleet in 
the form of five regions, referred to as management areas with differing depth and season 
restrictions. Until there is additional information on the distribution, life history 
differences between sunset and vermilion rockfishes, the current regional management 
framework is appropriate. The results from the ongoing SK grant exploring vermilion and sunset rockfish genetics will provide a more appropriate. HOwever, given the difficulty of differentiating 
the cryptic species pair without genetic identification, it is not feasible to separate landings 
of the two species.


# Unresolved Problems and Major Uncertainties
We recommend the following research be conducted before the next assessment:

\begin{enumerate}

\item Investigate the structure of complex and contribution of each species to the 
vermilion/sunset complex. Investigate possible spatial differences in biological parameters within 
a single species and also between the two species.  Little biological data for south of 
Point Conception or north of Point Arena were available for this assessment and is needed 
to better under biological parameters. 
    \begin{enumerate}
     \item Conduct life history studies
     \item Conduct research to identify the proportion of each species in population and in catches
    \end{enumerate}


\item Take a closer look at the Ralston historical catch reconstruction (\cite{Ralston2010}) and 
all other historical data sources.

\item Refine CCFRP survey index to look at alternative possible model structures, including 
a hierarchical structure and random effects. The CCFRP survey is the only 
fishery-independent survey available for nearshore rockfish sampling the nearshore rocky 
reef habitats. As of this assessment, only two years of coastwide data are available, 
and the index was limited to the site in central California that have been monitored 
since 2007.

\item Continue to investigate the most appropriate model structure for the NWFSC HL survey index.
The NWFSC HL survey is the only long-term fishery-independent survey in rocky (untrawlable) habitat 
in the Southern California Bight. We also recommend evaluating how to structure the NWFSC Hook-and-Line survey index given its expansion into the CCA, also independent analysis of information content in NWFSC Hook-and-Line survey.Increased spatiotemporal sampling around Pt. Conception would aid in identifing stock boundaries.

\item Utilize existing ROV survey data sources

 \begin{enumerate}
     \item SWFSC Submersible Survey of the Cowcod Conservation Areaa (\cite{Yok2007}). 
    This was a line-transect survey designed to estimate cowcod abundance in 2002 conducted from a submersible inside the \gls{cca}.  Originally, only cowcod were enumerated from the video footage.  Over the last few years, the SWFSC has re-analyzed the video footage to enumerate other rockfish species. 
     \item The SWFSC Fishery Resource Division (FRD) conducted a survey of potential cowcod habitat between Point Conception and the U.S. – Mexico border from October through December of 2012 (\cite{Stierhoff2013}).
     \item SWFSC staff are submitting proposals to conduct an additional submirsible survey in the southern California Bight
      \item CDFW ROV survey data
    \end{enumerate}


\item Collection of length and age data are recommended for both the commercial and 
recreational fisheries.  Very little age data are available from either fishery for 
vermilion and sunset rockfishes.

\item Investigate possible environmental drivers/co-variates for biological parameters, 
particularly for recruitment.

\item Resolve differences between CalCOM and PacFIN expanded length composition data sets. 

\end{enumerate}


<!--chapter:end:40management.Rmd-->

# Acknowledgments
Here are all the mad props!

<!--chapter:end:41acknowledgements.Rmd-->

\floatplacement{table}{H}

# Tables

```{r render-51, results = "asis"}
sa4ss::read_child("51tables-execsummary.Rmd")
```

```{r render-52, results = "asis"}
sa4ss::read_child("52tables-catch.Rmd")
```


```{r render-54, results = "asis"}
sa4ss::read_child("54tables-compsamplesize.Rmd")
```

```{r render-56, results = "asis"}
sa4ss::read_child("56tables-results.Rmd")
```

<!--chapter:end:50tables.Rmd-->

\clearpage
# Figures


```{r render-61, results = "asis"}
sa4ss::read_child("61figures-data-catches.Rmd")
```


```{r render-62, results = "asis"}
sa4ss::read_child("62figures-lengths.Rmd")
```


```{r render-63, results = "asis"}
sa4ss::read_child("63figures-biology.Rmd")
```

\FloatBarrier

```{r render-64, results = "asis"}
sa4ss::read_child("64figures-selectivity-diagnostics.Rmd")
```

\FloatBarrier


```{r render-65, results = "asis"}
sa4ss::read_child("65figures-lenfits.Rmd")
```

\FloatBarrier

```{r render-66, results = "asis"}
sa4ss::read_child("66figures-timeseries.Rmd")
```

\FloatBarrier

```{r render-67, results = "asis"}
sa4ss::read_child("67figures-indices-age.Rmd")
```

\FloatBarrier

```{r render-68, results = "asis"}
sa4ss::read_child("68figures-recruit-refpoints.Rmd")
```

\FloatBarrier

```{r render-69, results = "asis"}
sa4ss::read_child("69figures-sens-likeli-retro.Rmd")
```

<!--chapter:end:60figures.Rmd-->

\clearpage

# Appendix


## Annual Length Composition Data

```{r, results='asis'}
plot_info = read.csv(file.path(mod_loc, "plots", "plotinfotable_for_doc.csv"))
len_fit = plot_info[which(plot_info$category == "CompDat"), ]
plot.vec = grep("comp_lendat_flt", len_fit$label)
filein = file.path(mod_loc, "plots")
for (a in plot.vec){
	cap = len_fit$caption[a]
	lab = len_fit$label[a]
	add_figure(filein = file.path(filein, len_fit$file[a]), 
			   caption = cap, 
			   label = lab)
}
```

\newpage

## Detailed Fit to Length Composition Data{#append-fit} 


```{r, results='asis'}
plot_info = read.csv(file.path(mod_loc, "plots", "plotinfotable_for_doc.csv"))
len_fit = plot_info[which(plot_info$category == "LenComp"), ]
plot.vec = grep("comp_lenfit_flt", len_fit$label)
filein = file.path(mod_loc, "plots")
for (a in plot.vec){
	cap = len_fit$caption[a]
	lab = len_fit$label[a]
	add_figure(filein = file.path(filein, len_fit$file[a]), 
			   caption = cap, 
			   label = lab)
}
```

\newpage

##Indices


```{r, results = "asis"}
files_intro <- dir("./indices", pattern = paste0("*", model.area,".md$"), full.names = TRUE)
ignore <- mapply(read_child, files_intro)
```



<!--chapter:end:70appendices.Rmd-->

